using System.Collections.ObjectModel;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Net.Http.Json;
using System.Text.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Shapes;
using Microsoft.AspNetCore.SignalR.Client;

namespace GalaxyUML.UI;

public partial class MainWindow : Window
{
    private readonly ObservableCollection<TeamViewItem> _teams = [];
    private readonly ObservableCollection<MeetingViewItem> _meetings = [];
    private readonly ObservableCollection<MeetingParticipantViewItem> _meetingParticipants = [];
    private readonly ObservableCollection<BoxViewItem> _boxes = [];
    private readonly Dictionary<Guid, BoxViewItem> _boxesById = [];
    private readonly Dictionary<Guid, Rectangle> _boxShapesById = [];
    private readonly Dictionary<Rectangle, BoxViewItem> _shapeToBox = [];
    private readonly List<LineViewItem> _lineLinks = [];

    private Guid? _currentUserId;
    private string? _jwtToken;
    private Guid? _activeBoardId;
    private Guid? _activeMeetingId;
    private HubConnection? _hubConnection;

    private string _selectedTool = "ClassBox";
    private Point _dragStart;
    private Rectangle? _previewRectangle;
    private bool _isDragging;
    private bool _isMovingBox;
    private Rectangle? _movingBoxShape;
    private BoxViewItem? _movingBox;
    private Point _moveStartPoint;
    private double _moveStartLeft;
    private double _moveStartTop;

    public MainWindow()
    {
        InitializeComponent();

        TeamsListBox.ItemsSource = _teams;
        MeetingTeamComboBox.ItemsSource = _teams;
        MeetingsListBox.ItemsSource = _meetings;
        MeetingParticipantsListBox.ItemsSource = _meetingParticipants;
        StartBoxComboBox.ItemsSource = _boxes;
        EndBoxComboBox.ItemsSource = _boxes;

        TeamStatusText.Text = "Nema akcije.";
        MeetingStatusText.Text = "Nema aktivnih mitinga.";
        BoardStatusText.Text = "Pokreni miting da dobijes board (dijagram).";
        BoardInfoText.Text = "Board nije aktivan.";

        SetLineControlsVisibility();
    }

    private async void RegisterButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            var payload = new
            {
                firstName = RegisterFirstNameTextBox.Text.Trim(),
                lastName = RegisterLastNameTextBox.Text.Trim(),
                username = RegisterUsernameTextBox.Text.Trim(),
                email = RegisterEmailTextBox.Text.Trim(),
                password = RegisterPasswordBox.Password
            };

            await PostAsync("/api/auth/register", payload);
            RegisterFirstNameTextBox.Clear();
            RegisterLastNameTextBox.Clear();
            RegisterUsernameTextBox.Clear();
            RegisterEmailTextBox.Clear();
            RegisterPasswordBox.Clear();
            MessageBox.Show("Registracija uspesna.", "Auth", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Register", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void LoginButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            var payload = new
            {
                username = LoginUsernameTextBox.Text.Trim(),
                password = LoginPasswordBox.Password
            };

            var response = await PostAndReadAsync<LoginResponse>("/api/auth/login", payload);
            _jwtToken = response.Token;
            _currentUserId = response.User.IdUser;
            SessionStatusText.Text = $"Ulogovan: {response.User.Username} ({response.User.IdUser})";
            TeamStatusText.Text = "Spreman za tim operacije.";
            MeetingStatusText.Text = "Spreman za pokretanje mitinga.";
            await RefreshLoggedInUserTeamsAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Login", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void CreateTeamButton_Click(object sender, RoutedEventArgs e)
    {
        if (_currentUserId is null)
        {
            MessageBox.Show("Prvo se uloguj.", "Tim", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        var teamName = CreateTeamNameTextBox.Text.Trim();
        if (string.IsNullOrWhiteSpace(teamName))
        {
            MessageBox.Show("Unesi naziv tima.", "Tim", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            var created = await PostAndReadAsync<TeamResponse>("/api/teams", new { teamName, ownerId = _currentUserId.Value });
            CreateTeamNameTextBox.Clear();
            TeamStatusText.Text = $"Kreiran tim '{created.TeamName}'. Kod: {created.TeamCode}";
            await RefreshLoggedInUserTeamsAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Create team", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void FindTeamByCodeButton_Click(object sender, RoutedEventArgs e)
    {
        var code = JoinCodeTextBox.Text.Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(code))
        {
            MessageBox.Show("Unesi team code.", "Tim", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            var found = await GetAsync<TeamResponse>($"/api/teams/by-code/{code}");
            TeamStatusText.Text = $"Pronadjen tim '{found.TeamName}' (owner: {found.OwnerId}, clanova: {found.MemberCount}).";
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Find team", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void JoinByCodeButton_Click(object sender, RoutedEventArgs e)
    {
        if (_currentUserId is null)
        {
            MessageBox.Show("Prvo se uloguj.", "Tim", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        var code = JoinCodeTextBox.Text.Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(code))
        {
            MessageBox.Show("Unesi team code.", "Tim", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            var joined = await PostAndReadAsync<TeamResponse>("/api/teams/join-by-code", new { userId = _currentUserId.Value, joinCode = code });
            TeamStatusText.Text = $"Uclanjen u tim '{joined.TeamName}' po kodu '{joined.TeamCode}'.";
            await RefreshLoggedInUserTeamsAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Join team", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void StartMeetingButton_Click(object sender, RoutedEventArgs e)
    {
        if (_currentUserId is null)
        {
            MessageBox.Show("Prvo se uloguj.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (MeetingTeamComboBox.SelectedItem is not TeamViewItem selectedTeam)
        {
            MessageBox.Show("Izaberi tim.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            var created = await PostAndReadAsync<MeetingStartedResponse>("/api/meetings", new
            {
                teamId = selectedTeam.Id,
                organizerId = _currentUserId.Value
            });

            _activeBoardId = created.BoardId;
            _activeMeetingId = created.MeetingId;
            BoardInfoText.Text = $"Board ID: {created.BoardId}";
            MeetingStatusText.Text = $"Miting pokrenut. Meeting: {created.MeetingId}";
            BoardStatusText.Text = "Aktivan board spreman. Prevuci misem da dodas kvadrat (ClassBox).";

            var meetingItem = new MeetingViewItem(created.MeetingId, created.TeamId, created.BoardId, created.StartedAtUtc);
            _meetings.Add(meetingItem);
            MeetingsListBox.SelectedItem = meetingItem;
            ResetLocalBoard();
            await RefreshMeetingParticipantsAsync(created.MeetingId);
            await ConnectToSignalRAsync(created.MeetingId);
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Start meeting", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void JoinMeetingButton_Click(object sender, RoutedEventArgs e)
    {
        if (_currentUserId is null)
        {
            MessageBox.Show("Prvo se uloguj.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (MeetingsListBox.SelectedItem is not MeetingViewItem selectedMeeting)
        {
            MessageBox.Show("Izaberi meeting.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            await PostAsync($"/api/meetings/{selectedMeeting.Id}/join", new { userId = _currentUserId.Value });
            _activeMeetingId = selectedMeeting.Id;
            _activeBoardId = selectedMeeting.BoardId;
            BoardInfoText.Text = $"Board ID: {selectedMeeting.BoardId}";
            MeetingStatusText.Text = $"Uspesno ste pridruzeni meeting-u {selectedMeeting.Id}.";
            await RefreshMeetingParticipantsAsync(selectedMeeting.Id);
            await ConnectToSignalRAsync(selectedMeeting.Id);
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Join meeting", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void EndMeetingButton_Click(object sender, RoutedEventArgs e)
    {
        if (_currentUserId is null)
        {
            MessageBox.Show("Prvo se uloguj.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (MeetingsListBox.SelectedItem is not MeetingViewItem selectedMeeting)
        {
            MessageBox.Show("Izaberi miting koji zelis da zavrsis.", "Miting", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            await PostAsync($"/api/meetings/{selectedMeeting.Id}/end", new { userId = _currentUserId.Value });
            _meetings.Remove(selectedMeeting);

            if (_activeMeetingId == selectedMeeting.Id)
            {
                _activeMeetingId = null;
                _activeBoardId = null;
                ResetLocalBoard();
                BoardInfoText.Text = "Board nije aktivan.";
                _meetingParticipants.Clear();

                if (_hubConnection is not null)
                {
                    await _hubConnection.InvokeAsync("LeaveMeeting", selectedMeeting.Id.ToString());
                    await _hubConnection.StopAsync();
                }
            }

            MeetingStatusText.Text = $"Miting {selectedMeeting.Id} je zavrsen.";
            BoardStatusText.Text = "Miting je zavrsen. Pokreni novi miting za crtanje.";
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "End meeting", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async void MeetingsListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (MeetingsListBox.SelectedItem is not MeetingViewItem selectedMeeting)
        {
            return;
        }

        _activeMeetingId = selectedMeeting.Id;
        _activeBoardId = selectedMeeting.BoardId;
        BoardInfoText.Text = $"Board ID: {selectedMeeting.BoardId}";
        await RefreshMeetingParticipantsAsync(selectedMeeting.Id);
    }

    private void ToolComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (ToolComboBox.SelectedItem is ComboBoxItem item && item.Content is string tool)
        {
            _selectedTool = tool;
            if (BoardStatusText is not null)
            {
                BoardStatusText.Text = $"Aktivan alat: {_selectedTool}";
            }

            SetLineControlsVisibility();
        }
    }

    private void SetLineControlsVisibility()
    {
        if (LineControlsWrap is null)
        {
            return;
        }

        LineControlsWrap.Visibility = _selectedTool == "Line" ? Visibility.Visible : Visibility.Collapsed;
    }

    private void ClearBoardButton_Click(object sender, RoutedEventArgs e)
    {
        ResetLocalBoard();
        BoardStatusText.Text = "Lokalni prikaz table je ociscen.";
    }

    private void BoardCanvas_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (_selectedTool != "ClassBox")
        {
            return;
        }

        if (e.OriginalSource is Rectangle existingShape &&
            _shapeToBox.TryGetValue(existingShape, out var existingBox))
        {
            _isMovingBox = true;
            _movingBoxShape = existingShape;
            _movingBox = existingBox;
            _moveStartPoint = e.GetPosition(BoardCanvas);
            _moveStartLeft = Canvas.GetLeft(existingShape);
            _moveStartTop = Canvas.GetTop(existingShape);
            BoardCanvas.CaptureMouse();
            e.Handled = true;
            return;
        }

        _dragStart = e.GetPosition(BoardCanvas);
        _isDragging = true;
        BoardCanvas.CaptureMouse();

        _previewRectangle = new Rectangle
        {
            Stroke = Brushes.Black,
            Fill = Brushes.White,
            StrokeThickness = 2
        };
        Panel.SetZIndex(_previewRectangle, 10);
        BoardCanvas.Children.Add(_previewRectangle);
    }

    private void BoardCanvas_MouseMove(object sender, MouseEventArgs e)
    {
        if (_isMovingBox && _movingBoxShape is not null && _movingBox is not null)
        {
            var movePoint = e.GetPosition(BoardCanvas);
            var newLeft = _moveStartLeft + (movePoint.X - _moveStartPoint.X);
            var newTop = _moveStartTop + (movePoint.Y - _moveStartPoint.Y);
            SetBoxPosition(_movingBox, newLeft, newTop);
            UpdateConnectedLines(_movingBox.Id);
            return;
        }

        if (!_isDragging || _previewRectangle is null)
        {
            return;
        }

        var current = e.GetPosition(BoardCanvas);
        var dx = current.X - _dragStart.X;
        var dy = current.Y - _dragStart.Y;
        var side = Math.Max(Math.Abs(dx), Math.Abs(dy));
        var left = dx >= 0 ? _dragStart.X : _dragStart.X - side;
        var top = dy >= 0 ? _dragStart.Y : _dragStart.Y - side;

        _previewRectangle.Width = side;
        _previewRectangle.Height = side;
        Canvas.SetLeft(_previewRectangle, left);
        Canvas.SetTop(_previewRectangle, top);
    }

    private async void BoardCanvas_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        if (_isMovingBox && _movingBoxShape is not null && _movingBox is not null)
        {
            _isMovingBox = false;
            BoardCanvas.ReleaseMouseCapture();

            var currentLeft = Canvas.GetLeft(_movingBoxShape);
            var currentTop = Canvas.GetTop(_movingBoxShape);
            var dx = (int)Math.Round(currentLeft - _moveStartLeft);
            var dy = (int)Math.Round(currentTop - _moveStartTop);

            try
            {
                if (dx != 0 || dy != 0)
                {
                    if (_currentUserId is null)
                    {
                        MessageBox.Show("Nemas dozvolu za crtanje.", "Move", MessageBoxButton.OK, MessageBoxImage.Warning);
                        SetBoxPosition(_movingBox, _moveStartLeft, _moveStartTop);
                        UpdateConnectedLines(_movingBox.Id);
                        return;
                    }

                    await PostAsync($"/api/diagram/{_movingBox.Id}/move", new { userId = _currentUserId.Value, dx, dy });
                    BoardStatusText.Text = $"Pomeran ClassBox: {_movingBox.Id}";
                }
            }
            catch (Exception ex)
            {
                SetBoxPosition(_movingBox, _moveStartLeft, _moveStartTop);
                UpdateConnectedLines(_movingBox.Id);
                MessageBox.Show(ex.Message, "Move class box", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            finally
            {
                _movingBoxShape = null;
                _movingBox = null;
            }

            return;
        }

        if (!_isDragging || _previewRectangle is null)
        {
            return;
        }

        _isDragging = false;
        BoardCanvas.ReleaseMouseCapture();

        if (_activeBoardId is null)
        {
            BoardStatusText.Text = "Nema aktivnog board-a. Prvo startuj miting.";
            BoardCanvas.Children.Remove(_previewRectangle);
            _previewRectangle = null;
            return;
        }

        if (_currentUserId is null)
        {
            BoardStatusText.Text = "Nemas dozvolu za crtanje. Prvo se uloguj.";
            BoardCanvas.Children.Remove(_previewRectangle);
            _previewRectangle = null;
            return;
        }

        var left = (int)Canvas.GetLeft(_previewRectangle);
        var top = (int)Canvas.GetTop(_previewRectangle);
        var side = (int)Math.Round(_previewRectangle.Width);

        if (side < 10)
        {
            BoardCanvas.Children.Remove(_previewRectangle);
            _previewRectangle = null;
            BoardStatusText.Text = "Kvadrat je previse mali.";
            return;
        }

        try
        {
            var created = await PostAndReadAsync<ElementCreateResponse>($"/api/diagram/{_activeBoardId}/class-box", new
            {
                userId = _currentUserId.Value,  // ✅ Šalji non-nullable Guid
                x1 = left,
                y1 = top,
                x2 = left + side,
                y2 = top + side,
                attributes = Array.Empty<string>(),
                methods = Array.Empty<string>()
            });

            var box = new BoxViewItem(created.Id, left, top, left + side, top + side);
            _boxes.Add(box);
            _boxesById[box.Id] = box;
            _boxShapesById[box.Id] = _previewRectangle;
            _shapeToBox[_previewRectangle] = box;
            StartBoxComboBox.Items.Refresh();
            EndBoxComboBox.Items.Refresh();
            BoardStatusText.Text = $"Dodat ClassBox: {created.Id}";
        }
        catch (Exception ex)
        {
            BoardCanvas.Children.Remove(_previewRectangle);
            MessageBox.Show(ex.Message, "ClassBox", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
        finally
        {
            _previewRectangle = null;
        }
    }

    private async void CreateLineButton_Click(object sender, RoutedEventArgs e)
    {
        if (_activeBoardId is null)
        {
            MessageBox.Show("Nema aktivnog board-a.", "Line", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (StartBoxComboBox.SelectedItem is not BoxViewItem start || EndBoxComboBox.SelectedItem is not BoxViewItem end)
        {
            MessageBox.Show("Izaberi start i end box.", "Line", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (start.Id == end.Id)
        {
            MessageBox.Show("Start i end box moraju biti razliciti.", "Line", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        try
        {
            var created = await PostAndReadAsync<ElementCreateResponse>($"/api/diagram/{_activeBoardId}/line", new
            {
                userId = _currentUserId,
                startBoxId = start.Id,
                endBoxId = end.Id,
                middleText = (string?)null,
                text1 = (string?)null,
                text2 = (string?)null
            });

            var line = new Line
            {
                Stroke = Brushes.Black,
                StrokeThickness = 3,
                StrokeStartLineCap = PenLineCap.Round,
                StrokeEndLineCap = PenLineCap.Round,
                X1 = (start.X1 + start.X2) / 2d,
                Y1 = (start.Y1 + start.Y2) / 2d,
                X2 = (end.X1 + end.X2) / 2d,
                Y2 = (end.Y1 + end.Y2) / 2d
            };
            Panel.SetZIndex(line, 20);
            BoardCanvas.Children.Add(line);
            _lineLinks.Add(new LineViewItem(created.Id, start.Id, end.Id, line));
            BoardStatusText.Text = $"Dodat Line: {created.Id}";
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message, "Line", MessageBoxButton.OK, MessageBoxImage.Warning);
        }
    }

    private async Task RefreshLoggedInUserTeamsAsync()
    {
        if (_currentUserId is null)
        {
            return;
        }

        var teams = await GetAsync<IReadOnlyCollection<TeamResponse>>($"/api/teams/by-user/{_currentUserId.Value}");
        _teams.Clear();
        foreach (var team in teams)
        {
            _teams.Add(new TeamViewItem(team.Id, team.TeamName, team.TeamCode, team.OwnerId, team.MemberCount));
        }

        MeetingTeamComboBox.Items.Refresh();
        TeamsListBox.Items.Refresh();
    }

    private async Task RefreshMeetingParticipantsAsync(Guid meetingId)
    {
        var participants = await GetAsync<IReadOnlyCollection<MeetingParticipantResponse>>($"/api/meetings/{meetingId}/participants");
        _meetingParticipants.Clear();
        foreach (var participant in participants)
        {
            _meetingParticipants.Add(new MeetingParticipantViewItem(
                participant.UserId,
                participant.Username,
                participant.Role,
                participant.CanDraw,
                participant.JoinedAtUtc));
        }
    }

    private void ResetLocalBoard()
    {
        BoardCanvas.Children.Clear();
        _boxes.Clear();
        _boxesById.Clear();
        _boxShapesById.Clear();
        _shapeToBox.Clear();
        _lineLinks.Clear();
    }

    private void SetBoxPosition(BoxViewItem box, double left, double top)
    {
        if (!_boxShapesById.TryGetValue(box.Id, out var shape))
        {
            return;
        }

        Canvas.SetLeft(shape, left);
        Canvas.SetTop(shape, top);

        var size = box.X2 - box.X1;
        box.X1 = (int)Math.Round(left);
        box.Y1 = (int)Math.Round(top);
        box.X2 = box.X1 + size;
        box.Y2 = box.Y1 + size;
    }

    private void UpdateConnectedLines(Guid boxId)
    {
        foreach (var link in _lineLinks.Where(l => l.StartBoxId == boxId || l.EndBoxId == boxId))
        {
            UpdateLineGeometry(link);
        }
    }

    private void UpdateLineGeometry(LineViewItem link)
    {
        if (!_boxesById.TryGetValue(link.StartBoxId, out var start) ||
            !_boxesById.TryGetValue(link.EndBoxId, out var end))
        {
            return;
        }

        link.Shape.X1 = (start.X1 + start.X2) / 2d;
        link.Shape.Y1 = (start.Y1 + start.Y2) / 2d;
        link.Shape.X2 = (end.X1 + end.X2) / 2d;
        link.Shape.Y2 = (end.Y1 + end.Y2) / 2d;
    }

    private async Task PostAsync(string path, object payload)
    {
        using var client = CreateClient();
        using var response = await client.PostAsJsonAsync(path, payload);
        await EnsureSuccess(response);
    }

    private async Task<T> PostAndReadAsync<T>(string path, object payload)
    {
        using var client = CreateClient();
        using var response = await client.PostAsJsonAsync(path, payload);
        await EnsureSuccess(response);
        var data = await response.Content.ReadFromJsonAsync<T>(JsonOptions);
        return data ?? throw new InvalidOperationException("Prazan odgovor sa servera.");
    }

    private async Task<T> GetAsync<T>(string path)
    {
        using var client = CreateClient();
        using var response = await client.GetAsync(path);
        await EnsureSuccess(response);
        var data = await response.Content.ReadFromJsonAsync<T>(JsonOptions);
        return data ?? throw new InvalidOperationException("Prazan odgovor sa servera.");
    }

    private async Task<T?> GetAsyncNullable<T>(string path) where T : class
    {
        using var client = CreateClient();
        using var response = await client.GetAsync(path);
        
        if (response.StatusCode == System.Net.HttpStatusCode.NoContent)
        {
            return null;
        }
        
        await EnsureSuccess(response);
        var data = await response.Content.ReadFromJsonAsync<T>(JsonOptions);
        return data;
    }

    private HttpClient CreateClient()
    {
        var baseUrl = ApiBaseUrlTextBox.Text.Trim().TrimEnd('/');
        if (string.IsNullOrWhiteSpace(baseUrl))
        {
            throw new InvalidOperationException("API URL je obavezan.");
        }

        var client = new HttpClient
        {
            BaseAddress = new Uri(baseUrl, UriKind.Absolute)
        };

        if (!string.IsNullOrWhiteSpace(_jwtToken))
        {
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", _jwtToken);
        }

        return client;
    }

    private static async Task EnsureSuccess(HttpResponseMessage response)
    {
        if (response.IsSuccessStatusCode)
        {
            return;
        }

        var body = await response.Content.ReadAsStringAsync();
        if (!string.IsNullOrWhiteSpace(body))
        {
            throw new InvalidOperationException($"API error ({(int)response.StatusCode}): {body}");
        }

        throw new InvalidOperationException($"API error ({(int)response.StatusCode}): {response.ReasonPhrase}");
    }

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private sealed class TeamViewItem(Guid id, string teamName, string teamCode, Guid ownerId, int memberCount)
    {
        public Guid Id { get; init; } = id;
        public string TeamName { get; set; } = teamName;
        public string TeamCode { get; set; } = teamCode;
        public Guid OwnerId { get; set; } = ownerId;
        public int MemberCount { get; set; } = memberCount;
        public string Display => $"{TeamName} | code: {TeamCode} | owner: {OwnerId} | clanova: {MemberCount}";
    }

    private sealed class MeetingViewItem(Guid id, Guid teamId, Guid boardId, DateTime startedAtUtc)
    {
        public Guid Id { get; init; } = id;
        public Guid TeamId { get; init; } = teamId;
        public Guid BoardId { get; init; } = boardId;
        public DateTime StartedAtUtc { get; init; } = startedAtUtc;
        public string Display => $"{Id} | team: {TeamId} | board: {BoardId} | utc: {StartedAtUtc:HH:mm:ss}";
    }

    private sealed class BoxViewItem(Guid id, int x1, int y1, int x2, int y2)
    {
        public Guid Id { get; init; } = id;
        public int X1 { get; set; } = x1;
        public int Y1 { get; set; } = y1;
        public int X2 { get; set; } = x2;
        public int Y2 { get; set; } = y2;
        public string Display => $"{Id} ({X1},{Y1})-({X2},{Y2})";
    }

    private sealed class LineViewItem(Guid id, Guid startBoxId, Guid endBoxId, Line shape)
    {
        public Guid Id { get; init; } = id;
        public Guid StartBoxId { get; init; } = startBoxId;
        public Guid EndBoxId { get; init; } = endBoxId;
        public Line Shape { get; init; } = shape;
    }

    private sealed class MeetingParticipantViewItem(Guid userId, string username, string role, bool canDraw, DateTime joinedAtUtc)
    {
        public Guid UserId { get; init; } = userId;
        public string Username { get; init; } = username;
        public string Role { get; init; } = role;
        public bool CanDraw { get; init; } = canDraw;
        public DateTime JoinedAtUtc { get; init; } = joinedAtUtc;
        public string Display => $"{Username} ({Role}) | draw: {(CanDraw ? "da" : "ne")} | {UserId}";
    }

    private sealed record LoginResponse(string Token, LoginUserResponse User);
    private sealed record LoginUserResponse(Guid IdUser, string Username, string Email);
    private sealed record TeamResponse(Guid Id, string TeamName, string TeamCode, Guid OwnerId, int MemberCount);
    private sealed record MeetingStartedResponse(Guid MeetingId, Guid BoardId, Guid TeamId, DateTime StartedAtUtc);
    private sealed record MeetingParticipantResponse(Guid UserId, string Username, string Role, bool CanDraw, DateTime JoinedAtUtc);
    private sealed record ElementCreateResponse(Guid Id);

    private async void MeetingTeamComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (MeetingTeamComboBox.SelectedItem is not TeamViewItem selectedTeam)
        {
            _meetings.Clear();
            MeetingStatusText.Text = "Nema izabranog tima.";
            return;
        }

        await RefreshActiveMeetingsForTeamAsync(selectedTeam.Id);
    }

    private async Task RefreshActiveMeetingsForTeamAsync(Guid teamId)
    {
        try
        {
            var meeting = await GetAsyncNullable<MeetingStartedResponse>($"/api/meetings/by-team/{teamId}/active");
            
            _meetings.Clear();
            
            if (meeting is not null)
            {
                _meetings.Add(new MeetingViewItem(meeting.MeetingId, meeting.TeamId, meeting.BoardId, meeting.StartedAtUtc));
                MeetingStatusText.Text = $"Pronadjen aktivan miting za tim.";
            }
            else
            {
                MeetingStatusText.Text = "Nema aktivnih mitinga za ovaj tim.";
            }
            
            MeetingsListBox.Items.Refresh();
        }
        catch (Exception ex)
        {
            _meetings.Clear();
            MeetingStatusText.Text = $"Greska: {ex.Message}";
        }
    }

    private async Task ConnectToSignalRAsync(Guid meetingId)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.StopAsync();
            await _hubConnection.DisposeAsync();
        }

        var baseUrl = ApiBaseUrlTextBox.Text.Trim().TrimEnd('/');
        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{baseUrl}/diagramHub", options =>
            {
                if (!string.IsNullOrWhiteSpace(_jwtToken))
                {
                    options.AccessTokenProvider = () => Task.FromResult(_jwtToken)!;
                }
            })
            .WithAutomaticReconnect()
            .Build();

        // Listen for ClassBox additions from other clients
        _hubConnection.On<Guid, int, int, int, int>("ClassBoxAdded", (id, x1, y1, x2, y2) =>
        {
            Dispatcher.Invoke(() =>
            {
                // Check if already exists (to avoid duplicating our own boxes)
                if (_boxesById.ContainsKey(id)) return;

                var rect = new Rectangle
                {
                    Stroke = Brushes.Black,
                    Fill = Brushes.White,
                    StrokeThickness = 2,
                    Width = x2 - x1,
                    Height = y2 - y1
                };
                Canvas.SetLeft(rect, x1);
                Canvas.SetTop(rect, y1);
                Panel.SetZIndex(rect, 10);
                BoardCanvas.Children.Add(rect);

                var box = new BoxViewItem(id, x1, y1, x2, y2);
                _boxes.Add(box);
                _boxesById[id] = box;
                _boxShapesById[id] = rect;
                _shapeToBox[rect] = box;
                StartBoxComboBox.Items.Refresh();
                EndBoxComboBox.Items.Refresh();
            });
        });

        // Listen for element moves from other clients
        _hubConnection.On<Guid, int, int>("ElementMoved", (elementId, dx, dy) =>
        {
            Dispatcher.Invoke(() =>
            {
                if (_boxesById.TryGetValue(elementId, out var box))
                {
                    var newLeft = box.X1 + dx;
                    var newTop = box.Y1 + dy;
                    SetBoxPosition(box, newLeft, newTop);
                    UpdateConnectedLines(elementId);
                }
            });
        });

        // Listen for line additions from other clients
        _hubConnection.On<Guid, Guid, Guid, double, double, double, double>("LineAdded", (id, startBoxId, endBoxId, x1, y1, x2, y2) =>
        {
            Dispatcher.Invoke(() =>
            {
                // Check if already exists
                if (_lineLinks.Any(l => l.Id == id)) return;

                var line = new Line
                {
                    Stroke = Brushes.Black,
                    StrokeThickness = 3,
                    StrokeStartLineCap = PenLineCap.Round,
                    StrokeEndLineCap = PenLineCap.Round,
                    X1 = x1,
                    Y1 = y1,
                    X2 = x2,
                    Y2 = y2
                };
                Panel.SetZIndex(line, 20);
                BoardCanvas.Children.Add(line);
                _lineLinks.Add(new LineViewItem(id, startBoxId, endBoxId, line));
            });
        });

        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("JoinMeeting", meetingId.ToString());
        
        // Load existing elements on the board
        if (_activeBoardId.HasValue)
        {
            await LoadExistingElementsAsync(_activeBoardId.Value);
        }
        
        BoardStatusText.Text = "Povezan na SignalR - real-time sinhronizacija aktivna!";
    }

    private async Task LoadExistingElementsAsync(Guid boardId)
    {
        try
        {
            var response = await GetAsync<BoardElementsResponse>($"/api/diagram/{boardId}/elements");
            
            // Load boxes
            foreach (var boxData in response.Boxes)
            {
                if (_boxesById.ContainsKey(boxData.Id)) continue;

                var rect = new Rectangle
                {
                    Stroke = Brushes.Black,
                    Fill = Brushes.White,
                    StrokeThickness = 2,
                    Width = boxData.X2 - boxData.X1,
                    Height = boxData.Y2 - boxData.Y1
                };
                Canvas.SetLeft(rect, boxData.X1);
                Canvas.SetTop(rect, boxData.Y1);
                Panel.SetZIndex(rect, 10);
                BoardCanvas.Children.Add(rect);

                var box = new BoxViewItem(boxData.Id, boxData.X1, boxData.Y1, boxData.X2, boxData.Y2);
                _boxes.Add(box);
                _boxesById[box.Id] = box;
                _boxShapesById[box.Id] = rect;
                _shapeToBox[rect] = box;
            }

            // Load lines
            foreach (var lineData in response.Lines)
            {
                if (_lineLinks.Any(l => l.Id == lineData.Id)) continue;

                var line = new Line
                {
                    Stroke = Brushes.Black,
                    StrokeThickness = 3,
                    StrokeStartLineCap = PenLineCap.Round,
                    StrokeEndLineCap = PenLineCap.Round,
                    X1 = lineData.X1,
                    Y1 = lineData.Y1,
                    X2 = lineData.X2,
                    Y2 = lineData.Y2
                };
                Panel.SetZIndex(line, 20);
                BoardCanvas.Children.Add(line);
                _lineLinks.Add(new LineViewItem(lineData.Id, lineData.StartBoxId, lineData.EndBoxId, line));
            }

            StartBoxComboBox.Items.Refresh();
            EndBoxComboBox.Items.Refresh();
        }
        catch (Exception ex)
        {
            BoardStatusText.Text = $"Greska pri ucitavanju elemenata: {ex.Message}";
        }
    }

    private sealed record BoardElementsResponse(IReadOnlyCollection<BoxData> Boxes, IReadOnlyCollection<LineData> Lines);
    private sealed record BoxData(Guid Id, int X1, int Y1, int X2, int Y2);
    private sealed record LineData(Guid Id, Guid StartBoxId, Guid EndBoxId, double X1, double Y1, double X2, double Y2);
}


